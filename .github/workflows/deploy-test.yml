name: Deploy to Test Server

on:
  push:
    branches:
      - 'claude/review-html-premium-client-a03L4'
  workflow_dispatch:  # Allow manual trigger

jobs:
  deploy-test:
    name: Deploy to claude-test folder
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate secrets are configured
        run: |
          echo "Checking required secrets..."
          MISSING=""

          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "‚ùå SSH_HOST is not set"
            MISSING="SSH_HOST $MISSING"
          else
            echo "‚úÖ SSH_HOST: ${{ secrets.SSH_HOST }}"
          fi

          if [ -z "${{ secrets.SSH_USER }}" ]; then
            echo "‚ùå SSH_USER is not set"
            MISSING="SSH_USER $MISSING"
          else
            echo "‚úÖ SSH_USER: ${{ secrets.SSH_USER }}"
          fi

          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå SSH_PRIVATE_KEY is not set"
            MISSING="SSH_PRIVATE_KEY $MISSING"
          else
            echo "‚úÖ SSH_PRIVATE_KEY is configured"
          fi

          if [ -z "${{ secrets.DEPLOY_PATH_TEST }}" ]; then
            echo "‚ùå DEPLOY_PATH_TEST is not set"
            MISSING="DEPLOY_PATH_TEST $MISSING"
          else
            echo "‚úÖ DEPLOY_PATH_TEST: ${{ secrets.DEPLOY_PATH_TEST }}"
          fi

          if [ -n "$MISSING" ]; then
            echo ""
            echo "‚ö†Ô∏è  Missing secrets: $MISSING"
            echo ""
            echo "Please configure these in GitHub:"
            echo "Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret"
            echo ""
            echo "See .github/DEPLOYMENT-QUICKSTART.md for setup instructions"
            exit 1
          fi

          echo ""
          echo "‚úÖ All required secrets are configured!"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy claude folder to test server
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'logs/' \
            --exclude 'claude_usage.log' \
            --exclude 'node_modules/' \
            claude/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.DEPLOY_PATH_TEST }}/claude/

      - name: Deploy Misc folder (student passwords)
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            Misc/ \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.DEPLOY_PATH_TEST }}/Misc/

      - name: Create logs directory on server
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "mkdir -p ${{ secrets.DEPLOY_PATH_TEST }}/claude/logs && chmod 755 ${{ secrets.DEPLOY_PATH_TEST }}/claude/logs"

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Deployment Summary
        run: |
          echo "‚úÖ Deployment completed successfully!"
          echo "üåê Test site: http://psd1.net/claude-test"
          echo "üìÅ Deployed from branch: ${{ github.ref_name }}"
          echo "üî® Commit: ${{ github.sha }}"

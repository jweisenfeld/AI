<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Usage Dashboard</title>
    <style>
        :root {
            --bg: #0f172a;
            --card: #1e293b;
            --card-border: #334155;
            --text: #e2e8f0;
            --text-muted: #94a3b8;
            --accent: #f59e0b;
            --accent2: #6366f1;
            --danger: #ef4444;
            --success: #10b981;
            --blue: #3b82f6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 24px;
        }
        h1 { font-size: 1.8rem; margin-bottom: 8px; }
        .subtitle { color: var(--text-muted); margin-bottom: 24px; }
        .upload-area {
            background: var(--card);
            border: 2px dashed var(--card-border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 24px;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .upload-area:hover, .upload-area.drag-over {
            border-color: var(--accent);
        }
        .upload-area p { color: var(--text-muted); margin-top: 8px; font-size: 0.9rem; }
        .upload-btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
        }
        input[type="file"] { display: none; }

        /* Summary cards */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .summary-card {
            background: var(--card);
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
        }
        .summary-card .label { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 4px; }
        .summary-card .value { font-size: 1.8rem; font-weight: 700; }
        .summary-card .detail { color: var(--text-muted); font-size: 0.8rem; margin-top: 4px; }
        .summary-card.danger .value { color: var(--danger); }
        .summary-card.success .value { color: var(--success); }
        .summary-card.accent .value { color: var(--accent); }
        .summary-card.blue .value { color: var(--blue); }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--card-border);
            padding-bottom: 0;
        }
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.95rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab:hover { color: var(--text); }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            background: var(--card);
            border-radius: 12px;
            overflow: hidden;
        }
        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--card-border);
        }
        th {
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent2);
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            user-select: none;
        }
        th:hover { background: rgba(99, 102, 241, 0.2); }
        th .sort-arrow { margin-left: 4px; font-size: 0.7rem; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(255,255,255,0.03); }
        td.number { text-align: right; font-variant-numeric: tabular-nums; }
        td.danger { color: var(--danger); font-weight: 600; }
        td.muted { color: var(--text-muted); }

        /* Bar chart */
        .bar-chart { margin: 16px 0; }
        .bar-row {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
            gap: 12px;
        }
        .bar-label {
            min-width: 100px;
            font-size: 0.85rem;
            text-align: right;
            color: var(--text-muted);
        }
        .bar-track {
            flex: 1;
            height: 24px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            padding: 0 8px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #000;
            min-width: fit-content;
        }
        .bar-fill.haiku { background: var(--success); }
        .bar-fill.sonnet { background: var(--accent); }
        .bar-fill.opus { background: var(--danger); }
        .bar-fill.default { background: var(--blue); }

        /* Cost estimate */
        .cost-note {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            font-size: 0.9rem;
        }
        .cost-note strong { color: var(--danger); }

        /* Filters */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filters label { color: var(--text-muted); font-size: 0.85rem; }
        .filters select, .filters input {
            background: var(--card);
            border: 1px solid var(--card-border);
            color: var(--text);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        /* Scrollable table wrapper */
        .table-wrap {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--card-border);
        }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            body { padding: 12px; }
            .summary-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <h1>Claude Usage Dashboard</h1>
    <p class="subtitle">Upload your <code>claude_usage.log</code> file to analyze student usage patterns and costs.</p>

    <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
        <div style="font-size: 2rem;">ðŸ“Š</div>
        <p>Drop <code>claude_usage.log</code> here or click to browse</p>
        <button class="upload-btn">Choose File</button>
        <input type="file" id="file-input" accept=".log,.txt,.json" onchange="handleFile(event)">
    </div>

    <div id="dashboard" class="hidden">
        <!-- Summary Cards -->
        <div class="summary-grid" id="summary-cards"></div>

        <!-- Cost Warning -->
        <div class="cost-note" id="cost-note"></div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="showTab('students')">Students</button>
            <button class="tab" onclick="showTab('daily')">Daily</button>
            <button class="tab" onclick="showTab('hourly')">Hourly</button>
            <button class="tab" onclick="showTab('models')">Models</button>
            <button class="tab" onclick="showTab('prompts')">Recent Prompts</button>
            <button class="tab" onclick="showTab('alerts')">Alerts</button>
        </div>

        <!-- Student Breakdown -->
        <div class="tab-content active" id="tab-students">
            <div class="table-wrap">
                <table id="student-table">
                    <thead><tr>
                        <th onclick="sortTable('student-table', 0)">Student ID <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('student-table', 1)">Requests <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('student-table', 2)">Input Tokens <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('student-table', 3)">Output Tokens <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('student-table', 4)">Total Tokens <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('student-table', 5)">Est. Cost <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('student-table', 6)">Max Msg Count <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('student-table', 7)">Models Used <span class="sort-arrow"></span></th>
                        <th onclick="sortTable('student-table', 8)">Last Active <span class="sort-arrow"></span></th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Daily Breakdown -->
        <div class="tab-content" id="tab-daily">
            <div class="bar-chart" id="daily-chart"></div>
            <div class="table-wrap">
                <table id="daily-table">
                    <thead><tr>
                        <th onclick="sortTable('daily-table', 0)">Date</th>
                        <th onclick="sortTable('daily-table', 1)">Requests</th>
                        <th onclick="sortTable('daily-table', 2)">Unique Students</th>
                        <th onclick="sortTable('daily-table', 3)">Total Tokens</th>
                        <th onclick="sortTable('daily-table', 4)">Est. Cost</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Hourly Breakdown -->
        <div class="tab-content" id="tab-hourly">
            <div class="bar-chart" id="hourly-chart"></div>
        </div>

        <!-- Model Breakdown -->
        <div class="tab-content" id="tab-models">
            <div class="bar-chart" id="model-chart"></div>
            <div class="table-wrap">
                <table id="model-table">
                    <thead><tr>
                        <th>Model</th>
                        <th>Requests</th>
                        <th>Total Tokens</th>
                        <th>Est. Cost</th>
                        <th>% of Total Cost</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Recent Prompts -->
        <div class="tab-content" id="tab-prompts">
            <div class="filters">
                <label>Student:</label>
                <select id="prompt-student-filter" onchange="renderPrompts()">
                    <option value="">All Students</option>
                </select>
            </div>
            <div class="table-wrap">
                <table id="prompt-table">
                    <thead><tr>
                        <th>Timestamp</th>
                        <th>Student</th>
                        <th>Model</th>
                        <th>Msg#</th>
                        <th>User Prompt (first 500 chars)</th>
                    </tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Alerts -->
        <div class="tab-content" id="tab-alerts">
            <div id="alerts-list"></div>
        </div>
    </div>

    <script>
        let allEntries = [];
        let currentSort = {};

        // Pricing per 1M tokens â€” updated 2026-02-20 from platform.claude.com/docs/en/about-claude/pricing
        const COSTS = {
            'claude-haiku-4-5-20251001': { input: 1.00,  output: 5.00 },
            'claude-haiku-4-5':          { input: 1.00,  output: 5.00 },
            'claude-3-haiku-20240307':   { input: 0.25,  output: 1.25 },
            'claude-haiku-3-5-20241022': { input: 0.80,  output: 4.00 },
            'claude-sonnet-4-6':         { input: 3.00,  output: 15.00 },
            'claude-sonnet-4-5-20250929':{ input: 3.00,  output: 15.00 },
            'claude-sonnet-4-5':         { input: 3.00,  output: 15.00 },
            'claude-sonnet-4-20250514':  { input: 3.00,  output: 15.00 },
            'claude-opus-4-6':           { input: 5.00,  output: 25.00 },
            'claude-opus-4-5-20251101':  { input: 5.00,  output: 25.00 },
            'claude-opus-4-5':           { input: 5.00,  output: 25.00 },
            'claude-opus-4-1-20250805':  { input: 15.00, output: 75.00 },
            'claude-opus-4-20250514':    { input: 15.00, output: 75.00 },
        };

        function estimateCost(model, inputTokens, outputTokens) {
            const rates = COSTS[model] || { input: 3.00, output: 15.00 }; // default to sonnet
            return (inputTokens / 1e6) * rates.input + (outputTokens / 1e6) * rates.output;
        }

        // File handling
        const uploadArea = document.getElementById('upload-area');
        uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.classList.add('drag-over'); });
        uploadArea.addEventListener('dragleave', e => { e.preventDefault(); uploadArea.classList.remove('drag-over'); });
        uploadArea.addEventListener('drop', e => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            if (e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]);
        });

        function handleFile(event) {
            if (event.target.files.length) processFile(event.target.files[0]);
        }

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = e => {
                const lines = e.target.result.split('\n').filter(l => l.trim());
                allEntries = [];
                for (const line of lines) {
                    try { allEntries.push(JSON.parse(line)); } catch {}
                }
                if (allEntries.length === 0) {
                    alert('No valid log entries found in file.');
                    return;
                }
                renderDashboard();
            };
            reader.readAsText(file);
        }

        function renderDashboard() {
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('upload-area').style.display = 'none';
            renderSummary();
            renderStudents();
            renderDaily();
            renderHourly();
            renderModels();
            renderPrompts();
            renderAlerts();
        }

        // ============ SUMMARY ============
        function renderSummary() {
            const totalRequests = allEntries.length;
            const students = new Set(allEntries.map(e => e.student_id).filter(s => s && s !== 'unknown'));
            let totalInput = 0, totalOutput = 0, totalCost = 0;
            for (const e of allEntries) {
                const it = e.input_tokens || 0;
                const ot = e.output_tokens || 0;
                totalInput += it;
                totalOutput += ot;
                totalCost += estimateCost(e.model, it, ot);
            }
            const days = new Set(allEntries.map(e => e.timestamp?.substring(0, 10)));
            const avgPerDay = (totalRequests / Math.max(days.size, 1)).toFixed(0);

            document.getElementById('summary-cards').innerHTML = `
                <div class="summary-card accent"><div class="label">Total Requests</div><div class="value">${totalRequests.toLocaleString()}</div><div class="detail">${avgPerDay}/day avg over ${days.size} days</div></div>
                <div class="summary-card blue"><div class="label">Unique Students</div><div class="value">${students.size}</div></div>
                <div class="summary-card"><div class="label">Total Tokens</div><div class="value">${((totalInput + totalOutput) / 1e6).toFixed(1)}M</div><div class="detail">${(totalInput/1e6).toFixed(1)}M in / ${(totalOutput/1e6).toFixed(1)}M out</div></div>
                <div class="summary-card danger"><div class="label">Estimated Cost</div><div class="value">$${totalCost.toFixed(2)}</div><div class="detail">Based on published API pricing</div></div>
            `;

            // Top spender warning
            const byStudent = {};
            for (const e of allEntries) {
                const sid = e.student_id || 'unknown';
                if (!byStudent[sid]) byStudent[sid] = { cost: 0, tokens: 0, requests: 0 };
                const it = e.input_tokens || 0, ot = e.output_tokens || 0;
                byStudent[sid].cost += estimateCost(e.model, it, ot);
                byStudent[sid].tokens += it + ot;
                byStudent[sid].requests += 1;
            }
            const sorted = Object.entries(byStudent).sort((a, b) => b[1].cost - a[1].cost);
            const top = sorted[0];
            const topPct = ((top[1].cost / totalCost) * 100).toFixed(0);

            document.getElementById('cost-note').innerHTML = `
                <strong>Top spender: ${top[0]}</strong> - $${top[1].cost.toFixed(2)} (${topPct}% of total cost) with ${top[1].requests} requests and ${(top[1].tokens/1e6).toFixed(1)}M tokens.
                ${top[1].requests > 100 ? '<br>This student has unusually high usage and may need a conversation with their teacher.' : ''}
            `;
        }

        // ============ STUDENTS ============
        function renderStudents() {
            const byStudent = {};
            for (const e of allEntries) {
                const sid = e.student_id || 'unknown';
                if (!byStudent[sid]) byStudent[sid] = { requests: 0, input: 0, output: 0, cost: 0, maxMsg: 0, models: new Set(), lastActive: '' };
                const s = byStudent[sid];
                s.requests++;
                const it = e.input_tokens || 0, ot = e.output_tokens || 0;
                s.input += it;
                s.output += ot;
                s.cost += estimateCost(e.model, it, ot);
                s.maxMsg = Math.max(s.maxMsg, e.message_count || 0);
                s.models.add(e.model_tier || e.model || '?');
                if (e.timestamp > s.lastActive) s.lastActive = e.timestamp;
            }

            const tbody = document.querySelector('#student-table tbody');
            tbody.innerHTML = Object.entries(byStudent)
                .sort((a, b) => b[1].cost - a[1].cost)
                .map(([sid, s]) => `<tr>
                    <td><strong>${esc(sid)}</strong></td>
                    <td class="number">${s.requests}</td>
                    <td class="number">${s.input.toLocaleString()}</td>
                    <td class="number">${s.output.toLocaleString()}</td>
                    <td class="number ${(s.input+s.output) > 1000000 ? 'danger' : ''}">${(s.input+s.output).toLocaleString()}</td>
                    <td class="number ${s.cost > 10 ? 'danger' : ''}">\$${s.cost.toFixed(2)}</td>
                    <td class="number ${s.maxMsg > 50 ? 'danger' : ''}">${s.maxMsg}</td>
                    <td class="muted">${[...s.models].join(', ')}</td>
                    <td class="muted">${s.lastActive}</td>
                </tr>`).join('');

            // Populate prompt filter
            const select = document.getElementById('prompt-student-filter');
            select.innerHTML = '<option value="">All Students</option>' +
                Object.keys(byStudent).sort().map(s => `<option value="${esc(s)}">${esc(s)}</option>`).join('');
        }

        // ============ DAILY ============
        function renderDaily() {
            const byDay = {};
            for (const e of allEntries) {
                const day = e.timestamp?.substring(0, 10) || 'unknown';
                if (!byDay[day]) byDay[day] = { requests: 0, students: new Set(), tokens: 0, cost: 0 };
                byDay[day].requests++;
                if (e.student_id && e.student_id !== 'unknown') byDay[day].students.add(e.student_id);
                const it = e.input_tokens || 0, ot = e.output_tokens || 0;
                byDay[day].tokens += it + ot;
                byDay[day].cost += estimateCost(e.model, it, ot);
            }

            const maxReq = Math.max(...Object.values(byDay).map(d => d.requests));

            document.getElementById('daily-chart').innerHTML = Object.entries(byDay)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([day, d]) => `
                    <div class="bar-row">
                        <div class="bar-label">${day}</div>
                        <div class="bar-track">
                            <div class="bar-fill default" style="width: ${(d.requests/maxReq*100)}%">${d.requests} req - \$${d.cost.toFixed(2)}</div>
                        </div>
                    </div>
                `).join('');

            const tbody = document.querySelector('#daily-table tbody');
            tbody.innerHTML = Object.entries(byDay)
                .sort((a, b) => a[0].localeCompare(b[0]))
                .map(([day, d]) => `<tr>
                    <td>${day}</td>
                    <td class="number">${d.requests}</td>
                    <td class="number">${d.students.size}</td>
                    <td class="number">${d.tokens.toLocaleString()}</td>
                    <td class="number">\$${d.cost.toFixed(2)}</td>
                </tr>`).join('');
        }

        // ============ HOURLY ============
        function renderHourly() {
            const byHour = {};
            for (let h = 0; h < 24; h++) byHour[h] = 0;
            for (const e of allEntries) {
                const h = parseInt(e.timestamp?.substring(11, 13) || '0');
                byHour[h]++;
            }
            const maxH = Math.max(...Object.values(byHour));

            document.getElementById('hourly-chart').innerHTML = Object.entries(byHour)
                .map(([h, count]) => {
                    const hour = parseInt(h);
                    const isSchool = (hour >= 7 && hour < 17);
                    return `<div class="bar-row">
                        <div class="bar-label">${hour.toString().padStart(2,'0')}:00</div>
                        <div class="bar-track">
                            <div class="bar-fill ${isSchool ? 'default' : 'opus'}" style="width: ${count > 0 ? Math.max((count/maxH*100), 2) : 0}%">${count > 0 ? count : ''}</div>
                        </div>
                    </div>`;
                }).join('') +
                '<p style="color: var(--text-muted); font-size: 0.8rem; margin-top: 12px;">Blue = school hours (7AM-5PM) | Red = after hours</p>';
        }

        // ============ MODELS ============
        function renderModels() {
            const byModel = {};
            let totalCost = 0;
            for (const e of allEntries) {
                const m = e.model || 'unknown';
                if (!byModel[m]) byModel[m] = { requests: 0, tokens: 0, cost: 0 };
                byModel[m].requests++;
                const it = e.input_tokens || 0, ot = e.output_tokens || 0;
                byModel[m].tokens += it + ot;
                const cost = estimateCost(m, it, ot);
                byModel[m].cost += cost;
                totalCost += cost;
            }

            const maxReq = Math.max(...Object.values(byModel).map(d => d.requests));
            document.getElementById('model-chart').innerHTML = Object.entries(byModel)
                .sort((a, b) => b[1].cost - a[1].cost)
                .map(([model, d]) => {
                    const tier = model.includes('haiku') ? 'haiku' : model.includes('opus') ? 'opus' : 'sonnet';
                    return `<div class="bar-row">
                        <div class="bar-label" style="min-width:200px; font-size:0.8rem">${model}</div>
                        <div class="bar-track">
                            <div class="bar-fill ${tier}" style="width: ${(d.requests/maxReq*100)}%">${d.requests} req - \$${d.cost.toFixed(2)}</div>
                        </div>
                    </div>`;
                }).join('');

            const tbody = document.querySelector('#model-table tbody');
            tbody.innerHTML = Object.entries(byModel)
                .sort((a, b) => b[1].cost - a[1].cost)
                .map(([model, d]) => `<tr>
                    <td>${model}</td>
                    <td class="number">${d.requests}</td>
                    <td class="number">${d.tokens.toLocaleString()}</td>
                    <td class="number">\$${d.cost.toFixed(2)}</td>
                    <td class="number">${totalCost > 0 ? ((d.cost/totalCost)*100).toFixed(1) : 0}%</td>
                </tr>`).join('');
        }

        // ============ PROMPTS ============
        function renderPrompts() {
            const filter = document.getElementById('prompt-student-filter').value;
            const entries = allEntries
                .filter(e => e.user_text) // only entries with verbose logging
                .filter(e => !filter || e.student_id === filter)
                .slice(-200) // last 200
                .reverse();

            const tbody = document.querySelector('#prompt-table tbody');
            if (entries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--text-muted); padding: 40px;">No prompt data available. Verbose logging (user_text field) was recently added -- new log entries will appear here.</td></tr>';
                return;
            }
            tbody.innerHTML = entries.map(e => `<tr>
                <td class="muted" style="white-space:nowrap">${e.timestamp || ''}</td>
                <td><strong>${esc(e.student_id || 'unknown')}</strong></td>
                <td class="muted">${e.model_tier || ''}</td>
                <td class="number">${e.message_count || ''}</td>
                <td style="max-width:500px; word-break:break-word; font-size:0.85rem">${esc(e.user_text || '')}</td>
            </tr>`).join('');
        }

        // ============ ALERTS ============
        function renderAlerts() {
            const alerts = [];

            // Students with very high usage
            const byStudent = {};
            for (const e of allEntries) {
                const sid = e.student_id || 'unknown';
                if (!byStudent[sid]) byStudent[sid] = { requests: 0, tokens: 0, maxMsg: 0, cost: 0, opusCount: 0 };
                byStudent[sid].requests++;
                const it = e.input_tokens || 0, ot = e.output_tokens || 0;
                byStudent[sid].tokens += it + ot;
                byStudent[sid].maxMsg = Math.max(byStudent[sid].maxMsg, e.message_count || 0);
                byStudent[sid].cost += estimateCost(e.model, it, ot);
                if (e.model_tier === 'opus' || (e.model || '').includes('opus')) byStudent[sid].opusCount++;
            }

            for (const [sid, s] of Object.entries(byStudent)) {
                if (s.maxMsg > 100) {
                    alerts.push({ level: 'danger', msg: `<strong>${esc(sid)}</strong> had a conversation with ${s.maxMsg} messages. This causes exponential token growth -- each message re-sends the entire history. The new 50-message cap will prevent this.` });
                }
                if (s.cost > 20) {
                    alerts.push({ level: 'danger', msg: `<strong>${esc(sid)}</strong> has cost an estimated $${s.cost.toFixed(2)}. Consider reviewing their usage.` });
                }
                if (s.opusCount > 10) {
                    alerts.push({ level: 'warning', msg: `<strong>${esc(sid)}</strong> used Opus ${s.opusCount} times. Opus costs 5x more than Sonnet and 19x more than Haiku.` });
                }
                if (s.requests > 200) {
                    alerts.push({ level: 'warning', msg: `<strong>${esc(sid)}</strong> has ${s.requests} total requests -- well above average.` });
                }
            }

            // After-hours usage
            let afterHoursCount = 0;
            for (const e of allEntries) {
                const h = parseInt(e.timestamp?.substring(11, 13) || '0');
                if (h < 7 || h >= 17) afterHoursCount++;
            }
            if (afterHoursCount > 0) {
                alerts.push({ level: 'info', msg: `${afterHoursCount} requests (${((afterHoursCount/allEntries.length)*100).toFixed(0)}%) occurred outside school hours (before 7AM or after 5PM). The new throttling will limit these to Haiku-only with 10 req/hour.` });
            }

            // Unknown student IDs
            const unknownCount = allEntries.filter(e => !e.student_id || e.student_id === 'unknown').length;
            if (unknownCount > 0) {
                alerts.push({ level: 'info', msg: `${unknownCount} requests have no student ID (logged before the student_id field was added).` });
            }

            document.getElementById('alerts-list').innerHTML = alerts.length === 0
                ? '<p style="color: var(--text-muted); padding: 20px;">No alerts.</p>'
                : alerts.map(a => `<div style="padding: 12px 16px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid ${a.level === 'danger' ? 'var(--danger)' : a.level === 'warning' ? 'var(--accent)' : 'var(--blue)'}; background: ${a.level === 'danger' ? 'rgba(239,68,68,0.1)' : a.level === 'warning' ? 'rgba(245,158,11,0.1)' : 'rgba(59,130,246,0.1)'}; font-size: 0.9rem;">${a.msg}</div>`).join('');
        }

        // ============ UTILITIES ============
        function esc(s) {
            const div = document.createElement('div');
            div.textContent = s || '';
            return div.innerHTML;
        }

        function showTab(name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab-content#tab-${name}`).classList.add('active');
            event.target.classList.add('active');
        }

        function sortTable(tableId, colIndex) {
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            const key = `${tableId}-${colIndex}`;
            const asc = currentSort[key] === 'asc' ? 'desc' : 'asc';
            currentSort[key] = asc;

            rows.sort((a, b) => {
                let va = a.cells[colIndex]?.textContent.trim().replace(/[$,%]/g, '') || '';
                let vb = b.cells[colIndex]?.textContent.trim().replace(/[$,%]/g, '') || '';
                const na = parseFloat(va.replace(/,/g, ''));
                const nb = parseFloat(vb.replace(/,/g, ''));
                if (!isNaN(na) && !isNaN(nb)) {
                    return asc === 'asc' ? na - nb : nb - na;
                }
                return asc === 'asc' ? va.localeCompare(vb) : vb.localeCompare(va);
            });

            tbody.innerHTML = '';
            rows.forEach(r => tbody.appendChild(r));
        }
    </script>
</body>
</html>

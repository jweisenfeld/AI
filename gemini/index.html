<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHS Engineering Portal</title>
    <style>
        /* CSS remains the same as your original file */
        :root { --primary: #1a73e8; --bg: #f8f9fa; --border: #dadce0; --text: #202124; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); height: 100vh; display: flex; flex-direction: column; margin: 0; color: var(--text); }
        .login-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); z-index: 999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 320px; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; }
        .header { background: white; padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .main-container { flex: 1; display: flex; overflow: hidden; justify-content: center; }
        .chat-area { width: 100%; max-width: 900px; background: white; display: flex; flex-direction: column; border-inline: 1px solid var(--border); }
        .messages { flex: 1; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 20px; display: flex; flex-direction: column; }
        .bubble { padding: 12px 18px; border-radius: 18px; max-width: 85%; line-height: 1.5; font-size: 0.95rem; }
        .user .bubble { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .assistant .bubble { background: #f1f3f4; align-self: flex-start; border-bottom-left-radius: 4px; }
        .input-area { padding: 20px; border-top: 1px solid var(--border); }
        .input-group { display: flex; gap: 10px; align-items: flex-start; }
        textarea { flex: 1; height: 60px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; resize: none; font-family: inherit; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .clip-btn { background: none; border: none; cursor: pointer; font-size: 1.4rem; padding: 5px; }
        #image-previews img { height: 50px; border-radius: 4px; border: 1px solid var(--border); margin-right: 5px; }
    </style>
</head>

<body>
    <div id="login-modal" class="login-overlay">
        <div class="login-card">
            <h2 style="color:var(--primary); margin-top:0;">Engineering Portal</h2>
            <input type="text" id="uid" class="login-input" placeholder="Student ID">
            <input type="password" id="pwd" class="login-input" placeholder="Password">
            <button class="btn" style="width:100%" onclick="handleLogin()">Login to Project</button>
        </div>
    </div>

    <header class="header">
        <div style="font-weight:bold; color:var(--primary)">OHS Engineering Firm</div>
        <div style="display:flex; gap:10px;">
            <select id="model-select">
                <option value="gemini-1.5-flash">Gemini 1.5 Flash (Fast/Daily)</option>
                <option value="gemini-1.5-pro">Gemini 1.5 Pro (High Reasoning)</option>
            </select>
            <select id="phase-select">
                <option value="1">Part 1: Proposal</option>
                <option value="2">Part 2: Research & Argument</option>
                <option value="3">Part 3: Journaling</option>
                <option value="4">Part 4: Prototype</option>
                <option value="5">Part 5: Testing</option>
                <option value="6">Part 6: Presentation</option>
            </select>
            <div id="user-tag" style="font-size:0.8em; background:#e8f0fe; padding:4px 10px; border-radius:15px;">Logged Out</div>
        </div>
    </header>

    <div class="main-container">
        <div class="chat-area">
            <div class="messages" id="messages"></div>
            <div id="image-previews" style="padding: 0 20px; display: flex; gap: 8px;"></div>
            <div class="input-area">
                <div class="input-group">
                    <button class="clip-btn" onclick="document.getElementById('file-input').click()">üìé</button>
                    <input type="file" id="file-input" multiple style="display:none" onchange="handleFiles(this)">
                    <textarea id="user-input" placeholder="Ask your Engineering Coach..."></textarea>
                    <button class="btn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let STUDENT_ID = null; let STUDENT_NAME = null; let HISTORY = []; let PENDING_IMAGES = [];

        // System Prompt Injection (Fix #4)
        const MASTER_RUBRIC = `You are the OHS Engineering Coach for freshmen in Pasco, WA. 
        Refer to these 6 Parts of the Unit: 1. Proposal, 2. Research, 3. Journaling, 4. Prototype, 5. Testing, 6. Presentation.
        Grading Criteria (NGSS):
        - Define: Analyze problem, identify criteria/constraints.
        - Concepts: Research principles, brainstorm solutions, clear sketches.
        - Solution: Justify design based on physics and constraints.
        - Prototype: Persevere to create; test and revise.
        Encourage students to document failures in their journals. If they ask for math help, remind them to verify with their Physics teacher.`;

        async function handleLogin() {
            const id = document.getElementById('uid').value;
            const pw = document.getElementById('pwd').value;
            const res = await fetch('api-proxy.php', {
                method: 'POST',
                body: JSON.stringify({ action: 'verify_login', student_id: id, password: pw })
            });
            const data = await res.json();
            if (data.success) {
                STUDENT_ID = id; STUDENT_NAME = data.student_name;
                document.getElementById('user-tag').textContent = "üë§ " + STUDENT_NAME;
                document.getElementById('login-modal').style.display = 'none';
            } else { alert("Login Failed"); }
        }

        function handleFiles(input) {
            for (let file of input.files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    PENDING_IMAGES.push({ inline_data: { mime_type: file.type, data: e.target.result.split(',')[1] } });
                    const img = document.createElement('img'); img.src = e.target.result;
                    document.getElementById('image-previews').appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text && PENDING_IMAGES.length === 0) return;

            appendBubble('user', text || "(Image Uploaded)");
            
            // Build the content parts for the Gemini API
            const userContent = [];
            if (text) userContent.push({ text: text });
            PENDING_IMAGES.forEach(img => userContent.push(img));
            
            HISTORY.push({ role: 'user', parts: userContent });
            input.value = ''; document.getElementById('image-previews').innerHTML = '';
            const currentImages = [...PENDING_IMAGES]; PENDING_IMAGES = [];

            const phaseIdx = document.getElementById('phase-select').value;
            const sys = `${MASTER_RUBRIC} The student is currently in Phase ${phaseIdx}.`;

            const res = await fetch('api-proxy.php', {
                method: 'POST',
                body: JSON.stringify({
                    action: 'chat', // Added for proxy routing
                    student_id: STUDENT_ID,
                    student_name: STUDENT_NAME,
                    model: document.getElementById('model-select').value,
                    system: sys,
                    messages: HISTORY
                })
            });

            const data = await res.json();
            if (data.candidates) {
                const reply = data.candidates[0].content.parts[0].text;
                appendBubble('assistant', reply);
                HISTORY.push({ role: 'model', parts: [{ text: reply }] });
                
                // Fix #5: Auto-log interaction to server
                logToTeacher(text, reply);
            } else {
                appendBubble('assistant', "‚ö†Ô∏è Error: " + (data.error?.message || "Connection failed."));
            }
        }

        // Fix #5: Logging Function
        async function logToTeacher(userText, botReply) {
            fetch('api-proxy.php', {
                method: 'POST',
                body: JSON.stringify({
                    action: 'log_interaction',
                    student_id: STUDENT_ID,
                    log: `USER: ${userText}\nBOT: ${botReply}\n---\n`
                })
            });
        }

        function appendBubble(role, text) {
            const messagesDiv = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${role === 'model' ? 'assistant' : 'user'}`;
            div.innerHTML = `<div class="bubble">${marked.parse(text)}</div>`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OHS Engineering Portal</title>
    <style>
        :root { --primary: #1a73e8; --bg: #f8f9fa; --border: #dadce0; --text: #202124; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); height: 100vh; display: flex; flex-direction: column; margin: 0; color: var(--text); }
        .login-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); z-index: 999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 320px; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; }
        .header { background: white; padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .main-container { flex: 1; display: flex; overflow: hidden; justify-content: center; }
        .chat-area { width: 100%; max-width: 900px; background: white; display: flex; flex-direction: column; border-inline: 1px solid var(--border); }
        .messages { flex: 1; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 20px; display: flex; flex-direction: column; }
        .bubble { padding: 12px 18px; border-radius: 18px; max-width: 85%; line-height: 1.5; font-size: 0.95rem; }
        .user .bubble { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .assistant .bubble { background: #f1f3f4; align-self: flex-start; border-bottom-left-radius: 4px; }
        .input-area { padding: 20px; border-top: 1px solid var(--border); }
        .input-group { display: flex; gap: 10px; align-items: flex-start; }
        textarea { flex: 1; height: 60px; padding: 12px; border: 1px solid var(--border); border-radius: 8px; resize: none; font-family: inherit; }
        .btn { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        #image-previews img { height: 50px; border-radius: 4px; border: 1px solid var(--border); margin-right: 5px; }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
        .thinking-bubble { font-style: italic; color: #888; animation: blink 1.2s ease-in-out infinite; }
        .ttfb-tag { font-size: 0.7em; color: #999; margin-top: 4px; align-self: flex-start; padding: 0 4px; }
        .upload-btn { background: none; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; padding: 6px 8px; display: flex; align-items: center; justify-content: center; color: #5f6368; position: relative; }
        .upload-btn:hover { background: #f1f3f4; border-color: #aaa; }
        .upload-btn svg { width: 20px; height: 20px; }
        .upload-btn::after { content: attr(data-tooltip); position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.75em; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.15s; }
        .upload-btn:hover::after { opacity: 1; }
        .copy-btn { background: none; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; padding: 6px 8px; display: flex; align-items: center; justify-content: center; color: #5f6368; font-size: 0.78em; gap: 4px; white-space: nowrap; position: relative; }
        .copy-btn:hover { background: #f1f3f4; border-color: #aaa; }
        .copy-btn svg { width: 16px; height: 16px; }
        .copy-btn::after { content: attr(data-tooltip); position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: #333; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 0.75em; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.15s; }
        .copy-btn:hover::after { opacity: 1; }
    </style>
</head>

<body>
    <div id="login-modal" class="login-overlay">
        <div class="login-card">
            <h2 style="color:var(--primary); margin-top:0;">Engineering Portal</h2>
            <input type="text" id="uid" class="login-input" placeholder="Student ID" autofocus>
            <input type="password" id="pwd" class="login-input" placeholder="Password">
            <button class="btn" style="width:100%" onclick="handleLogin()">Login to Project</button>
            <p style="margin:18px 0 0; font-size:0.75em; color:#aaa;">gemini3 &nbsp;¬∑&nbsp; v1.3 &nbsp;¬∑&nbsp; 2026-02-20 10:30</p>
        </div>
    </div>

    <header class="header">
        <div style="font-weight:bold; color:var(--primary)">OHS Engineering Firm</div>
        <div style="display:flex; gap:10px;">
            <select id="model-select">
                <option value="gemini-3-pro-preview">Gemini 3 Pro (Newest/Best)</option>
                <option value="gemini-2.5-flash">Gemini 2.5 Flash (Workhorse)</option>
                <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash-Lite (Fastest)</option>
            </select>
            <select id="phase-select">
                <option value="1">Part 1: Proposal</option>
                <option value="2">Part 2: Research & Argument</option>
                <option value="3">Part 3: Journaling</option>
                <option value="4">Part 4: Prototype</option>
                <option value="5">Part 5: Testing</option>
                <option value="6">Part 6: Presentation</option>
            </select>
            <div id="user-tag" style="font-size:0.8em; background:#e8f0fe; padding:4px 10px; border-radius:15px;">Logged Out</div>
        </div>
    </header>

    <div class="main-container">
        <div class="chat-area">
            <div class="messages" id="messages"></div>
            <div id="image-previews" style="padding: 0 20px; display: flex; gap: 8px;"></div>
            <div class="input-area">
                <div class="input-group">
                    <button class="upload-btn" data-tooltip="Upload a picture" onclick="document.getElementById('file-input').click()" aria-label="Upload a picture">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <polyline points="21 15 16 10 5 21"/>
                        </svg>
                    </button>
                    <input type="file" id="file-input" multiple style="display:none" onchange="handleFiles(this)" accept="image/*">
                    <textarea id="user-input" placeholder="Ask your Engineering Coach..."></textarea>
                    <button class="copy-btn" data-tooltip="Copy last response" onclick="copyLastResponse()" aria-label="Copy last AI response">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                            <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                        </svg>
                    </button>
                    <button class="btn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let STUDENT_ID = null; let STUDENT_NAME = null; let HISTORY = []; let PENDING_IMAGES = [];
        let LAST_RESPONSE_TEXT = '';  // plain text of the most recent AI reply

        const MASTER_RUBRIC = `
        ### ROLE
        You are the Senior Engineering Mentor for 9th-grade students at Orion High School in Pasco, WA.
        Your goal is to coach students through the Civil Engineering Argument Project using the Engineering Design Process.

        ### PROJECT FRAMEWORK
        Always guide students based on the 6 Parts of the Unit:
        1. Select project & write proposal[cite: 260, 267].
        2. Research solutions & argue for the best one[cite: 261, 270].
        3. Maintain an Individual Engineering Journal[cite: 262, 255].
        4. Produce a model or prototype[cite: 263, 256].
        5. Complete labs to test the prototype[cite: 264].
        6. Final Presentation (PowerPoint/Poster)[cite: 265, 275].

        ### NGSS EVALUATION CRITERIA (MS-ETS1)
        When providing feedback, reference these "Advanced (4)" standards:
        - DEFINE: Analyze the problem deeply and identify all criteria/constraints[cite: 148, 150].
        - CONCEPTS: Research scientific principles and justify solutions with physics[cite: 152, 158].
        - PROTOTYPE: Persevere through iterations. Failure is data[cite: 161].
        - EVALUATE: Analyze data from tests to identify flaws and suggest improvements[cite: 165, 166].

        ### PURVIEW & CONSTRAINTS
        - PHYSICS FOCUS: For Parts 4 & 5, ask: "What physics law (e.g., Newton's Laws) justifies this design choice?"[cite: 190].
        - JOURNALING: Remind students to document at least TWO failed iterations to reach the "Advanced" score[cite: 162].
        - MATH POLICY: Provide conceptual hints for math, but always state: "Verify these calculations with Mr. Weisenfeld"[cite: 191].
        - LOCAL CONTEXT: Reference Pasco, WA civic problems (e.g., crosswalk safety, road bottlenecks)[cite: 184, 194, 240].
        `;

        async function handleLogin() {
            const id = document.getElementById('uid').value;
            const pw = document.getElementById('pwd').value;
            const res = await fetch('api-proxy.php', {
                method: 'POST',
                body: JSON.stringify({ action: 'verify_login', student_id: id, password: pw })
            });
            const data = await res.json();
            if (data.success) {
                STUDENT_ID = id; STUDENT_NAME = data.student_name;
                document.getElementById('user-tag').textContent = "üë§ " + STUDENT_NAME;
                document.getElementById('login-modal').style.display = 'none';
            } else { alert("Login Failed"); }
        }

        function handleFiles(input) {
            for (let file of input.files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    PENDING_IMAGES.push({ inline_data: { mime_type: file.type, data: e.target.result.split(',')[1] } });
                    const img = document.createElement('img'); img.src = e.target.result;
                    document.getElementById('image-previews').appendChild(img);
                };
                reader.readAsDataURL(file);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const text = input.value.trim();
            if (!text && PENDING_IMAGES.length === 0) return;

            appendBubble('user', text || "(Image Uploaded)");

            const userContent = [];
            if (text) userContent.push({ text: text });
            PENDING_IMAGES.forEach(img => userContent.push(img));

            HISTORY.push({ role: 'user', parts: userContent });
            input.value = '';
            document.getElementById('image-previews').innerHTML = '';
            PENDING_IMAGES = [];

            const phaseIdx = document.getElementById('phase-select').value;
            const sys = `${MASTER_RUBRIC} The student is currently in Phase ${phaseIdx}.`;

            // Show "Thinking‚Ä¶" bubble immediately, before fetch starts
            const messagesDiv = document.getElementById('messages');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.className = 'message assistant';
            thinkingDiv.innerHTML = '<div class="bubble thinking-bubble">Thinking\u2026</div>';
            messagesDiv.appendChild(thinkingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            const requestBody = JSON.stringify({
                action: 'chat',
                student_id: STUDENT_ID,
                student_name: STUDENT_NAME,
                model: document.getElementById('model-select').value,
                system: sys,
                messages: HISTORY
            });

            try {
                const fetchStart = performance.now();
                const res = await fetch('api-proxy.php?stream=1', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: requestBody
                });

                if (!res.ok || !res.body) throw new Error('Stream unavailable');

                // Replace thinking bubble with an empty assistant bubble to fill in
                thinkingDiv.remove();
                const assistantDiv = document.createElement('div');
                assistantDiv.className = 'message assistant';
                assistantDiv.innerHTML = '<div class="bubble"></div>';
                messagesDiv.appendChild(assistantDiv);
                const bubbleEl = assistantDiv.querySelector('.bubble');

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let accumulated = '';
                let partialLine = '';
                let ttfbMs = null;  // time-to-first-byte (first text delta)

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    partialLine += decoder.decode(value, { stream: true });

                    // Process all complete lines; keep any trailing incomplete line
                    const lines = partialLine.split('\n');
                    partialLine = lines.pop();

                    for (const line of lines) {
                        const trimmed = line.trimEnd();
                        if (!trimmed.startsWith('data: ')) continue;

                        const payload = trimmed.slice(6);
                        if (payload === '[DONE]') break;

                        let parsed;
                        try { parsed = JSON.parse(payload); } catch { continue; }

                        if (parsed.error) throw new Error(JSON.stringify(parsed.error));

                        // Handle both our simplified {"text":"..."} wrapper AND
                        // Gemini's raw SSE format. For thinking models (Gemini 3 Pro),
                        // parts may include thoughtSignature blobs with empty text ‚Äî
                        // find the first part that has a non-empty text string.
                        let delta = parsed.text ?? null;
                        if (delta === null && Array.isArray(parsed.candidates?.[0]?.content?.parts)) {
                            for (const part of parsed.candidates[0].content.parts) {
                                if (typeof part.text === 'string' && part.text.length > 0
                                        && !part.thoughtSignature) {
                                    delta = part.text;
                                    break;
                                }
                            }
                        }
                        if (delta) {
                            if (ttfbMs === null) {
                                ttfbMs = Math.round(performance.now() - fetchStart);
                            }
                            accumulated += delta;
                            bubbleEl.innerHTML = marked.parse(accumulated);
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        }
                    }
                }

                // Show TTFB tag beneath the bubble
                if (ttfbMs !== null) {
                    const ttfbTag = document.createElement('div');
                    ttfbTag.className = 'ttfb-tag';
                    ttfbTag.textContent = `‚è± First byte: ${ttfbMs < 1000 ? ttfbMs + 'ms' : (ttfbMs/1000).toFixed(1) + 's'}`;
                    assistantDiv.appendChild(ttfbTag);
                }

                if (accumulated) {
                    LAST_RESPONSE_TEXT = accumulated;
                    HISTORY.push({ role: 'model', parts: [{ text: accumulated }] });
                    logToTeacher(text, accumulated, ttfbMs);
                }

            } catch (err) {
                // Streaming failed ‚Äî fall back to non-streaming route
                console.warn('SSE stream failed, falling back:', err);
                thinkingDiv.remove();

                try {
                    const res = await fetch('api-proxy.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: requestBody
                    });
                    const data = await res.json();
                    if (data.candidates) {
                        const reply = data.candidates[0].content.parts[0].text;
                        LAST_RESPONSE_TEXT = reply;
                        appendBubble('assistant', reply);
                        HISTORY.push({ role: 'model', parts: [{ text: reply }] });
                        logToTeacher(text, reply, null);
                    } else {
                        appendBubble('assistant', "‚ö†Ô∏è Error: " + (data.error?.message || "Connection failed."));
                    }
                } catch (fallbackErr) {
                    appendBubble('assistant', "‚ö†Ô∏è Connection failed. Please try again.");
                }
            }
        }

        async function logToTeacher(userText, botReply, ttfbMs) {
            const ttfbNote = ttfbMs !== null ? `TTFB: ${ttfbMs}ms\n` : '';
            fetch('api-proxy.php', {
                method: 'POST',
                body: JSON.stringify({
                    action: 'log_interaction',
                    student_id: STUDENT_ID,
                    ttfb_ms: ttfbMs,
                    log: `USER: ${userText}\n${ttfbNote}BOT: ${botReply}\n---\n`
                })
            });
        }

        async function copyLastResponse() {
            if (!LAST_RESPONSE_TEXT) return;
            try {
                await navigator.clipboard.writeText(LAST_RESPONSE_TEXT);
                const btn = document.querySelector('.copy-btn');
                const orig = btn.getAttribute('data-tooltip');
                btn.setAttribute('data-tooltip', 'Copied!');
                setTimeout(() => btn.setAttribute('data-tooltip', orig), 1500);
            } catch {
                // Fallback for older browsers
                const ta = document.createElement('textarea');
                ta.value = LAST_RESPONSE_TEXT;
                ta.style.position = 'fixed'; ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
            }
        }

        function appendBubble(role, text) {
            const messagesDiv = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `message ${role === 'model' ? 'assistant' : 'user'}`;
            div.innerHTML = `<div class="bubble">${marked.parse(text)}</div>`;
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Enter key support on login fields
        ['uid', 'pwd'].forEach(id =>
            document.getElementById(id).addEventListener('keydown', e => {
                if (e.key === 'Enter') { e.preventDefault(); handleLogin(); }
            })
        );
    </script>
</body>
</html>

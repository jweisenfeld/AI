<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=5"/>
  <title>What-if Grade Simulator — Cardenas, Alexis L. (39407)</title>
  <style>
    :root { --card-border:#ddd; --muted:#444; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:14px; background:#fff; }
    .wrap { max-width:1100px; margin:0 auto; }
    h2 { margin:0 0 6px 0; font-size:20px; }
    .meta { color:#333; margin:0 0 10px 0; line-height:1.35; font-size:13px; }
    .cards { display:grid; grid-template-columns:repeat(3, minmax(0, 1fr)); gap:10px; margin:10px 0; }
    .card { border:1px solid var(--card-border); border-radius:12px; padding:10px; background:#fff; }
    .label { font-size:12px; color:#555; margin-bottom:2px; }
    .value { font-size:22px; font-weight:750; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:8px 0 10px 0; }
    button { padding:8px 10px; border-radius:10px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer; font-size:14px; }
    button:hover { background:#f0f0f0; }
    .small { font-size:12px; color:var(--muted); line-height:1.35; }
    #chartWrap { width:100%; height:70vh; min-height:420px; border:1px solid #eee; border-radius:12px; overflow:hidden; background:#fff; position:relative; }
    @media (orientation: landscape) and (max-width: 1400px) { #chartWrap { height:78vh; min-height:480px; } }
    .tooltip { position:absolute; pointer-events:none; background:rgba(0,0,0,0.85); color:#fff; padding:6px 8px; border-radius:8px; font-size:12px; line-height:1.25; display:none; max-width:260px; }
    .disclaimer { margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35; }
  </style>
</head>
<body>
  <div class="wrap">
    <h2 id="studentTitle"></h2>
    <div class="meta">
      Drag the assessment points to see how changes could impact the overall grade (what-if). The official grade line does not move.
      Ghost rings show the starting score before you dragged.
    </div>

    <div class="cards">
      <div class="card">
        <div class="label">Official current grade (gradebook export)</div>
        <div class="value" id="officialVal">—</div>
      </div>
      <div class="card">
        <div class="label">What-if overall grade (updates as you drag)</div>
        <div class="value" id="whatifVal">—</div>
      </div>
      <div class="card">
        <div class="label">Change vs official</div>
        <div class="value" id="deltaVal">—</div>
      </div>
    </div>

    <div class="row">
      <button id="resetBtn" type="button">Reset scores</button>
    </div>

    <div class="small">
      Model on this page:
      overall = (0.90 × average(assessments)) + (0.10 × lesson_average) + constant_offset.<br/>
      lesson_average and constant_offset are held fixed so the page starts at the official current grade.
    </div>

    <div id="chartWrap">
      <div id="tooltip" class="tooltip"></div>
    </div>

    <div class="disclaimer">
      This is a planning / visualization tool. It does not change the gradebook. The gradebook is authoritative.
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
  const pageData = {"studentId": "39407", "studentName": "Cardenas, Alexis L.", "assessmentLabels": ["Unit 1 Assessment", "Unit 2 Assessment", "Unit 5 Assessment", "Unit 13 Assessment", "Unit 3 Assessment", "Unit 4 Assessment"], "originalScores": [66.0, 53.0, 97.0, 57.0, 98.0, null], "currentScores": [66.0, 53.0, 97.0, 57.0, 98.0, 0.0], "missingFlags": [false, false, false, false, false, true], "officialPercent": 68.0, "lessonAvg": 0.0, "weights": {"assessments": 0.9, "lessons": 0.1}, "offset": 1.2199999999999989, "minPassing": 60.0, "yMax": 105.0};

  const wrap = document.getElementById("chartWrap");
  const tip  = document.getElementById("tooltip");

  function fmtPct(v){ return (Number.isFinite(v) ? v.toFixed(1) + "%" : "—"); }
  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
  function avg(vals){
    const xs = vals.filter(v => Number.isFinite(v));
    return xs.length ? xs.reduce((a,b)=>a+b,0)/xs.length : NaN;
  }
  function computeWhatIf(scoresArr){
    const assessAvg = avg(scoresArr);
    if (!Number.isFinite(assessAvg)) return NaN;
    return pageData.weights.assessments * assessAvg
         + pageData.weights.lessons * pageData.lessonAvg
         + pageData.offset;
  }
  function updateStats(){
    const official = pageData.officialPercent;
    const whatif = computeWhatIf(pageData.currentScores);
    document.getElementById("officialVal").textContent = fmtPct(official);
    document.getElementById("whatifVal").textContent  = fmtPct(whatif);
    document.getElementById("deltaVal").textContent   = Number.isFinite(whatif)
      ? ((whatif - official >= 0 ? "+" : "") + (whatif - official).toFixed(1) + "%")
      : "—";
    return whatif;
  }

  document.getElementById("studentTitle").textContent = pageData.studentName + " (" + pageData.studentId + ")";

  function clientXY(se){
    if (!se) return {x:0, y:0};
    if (se.touches && se.touches.length) return {x: se.touches[0].clientX, y: se.touches[0].clientY};
    if (se.changedTouches && se.changedTouches.length) return {x: se.changedTouches[0].clientX, y: se.changedTouches[0].clientY};
    return {x: se.clientX || 0, y: se.clientY || 0};
  }

  function showTip(html, xPx, yPx){
    tip.innerHTML = html;
    tip.style.left = (xPx + 10) + "px";
    tip.style.top  = (yPx + 10) + "px";
    tip.style.display = "block";
  }
  function hideTip(){ tip.style.display = "none"; }

  const margin = {top:18, right:18, bottom:92, left:54};

  function render(){
    // wipe any prior svg
    Array.from(wrap.querySelectorAll("svg")).forEach(n => n.remove());

    const rect = wrap.getBoundingClientRect();
    const W = Math.max(320, rect.width);
    const H = Math.max(420, rect.height);

    const innerW = W - margin.left - margin.right;
    const innerH = H - margin.top - margin.bottom;

    const svg = d3.select(wrap).append("svg")
      .attr("width", W)
      .attr("height", H);

    const g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    const x = d3.scalePoint()
      .domain(pageData.assessmentLabels)
      .range([0, innerW])
      .padding(0.5);

    const y = d3.scaleLinear()
      .domain([0, pageData.yMax])
      .range([innerH, 0]);

    // axes
    g.append("g")
      .attr("transform", "translate(0," + innerH + ")")
      .call(d3.axisBottom(x))
      .selectAll("text")
      .attr("transform", "rotate(50)")
      .style("text-anchor", "start")
      .style("font-size", "12px");

    g.append("g").call(d3.axisLeft(y).ticks(7));

    // y label
    g.append("text")
      .attr("x", -36).attr("y", -6)
      .style("font-size", "12px")
      .style("fill", "#333")
      .text("Score (%)");

    function hline(val, stroke, dash, label){
      const yPos = y(val);
      g.append("line")
        .attr("x1", 0).attr("x2", innerW)
        .attr("y1", yPos).attr("y2", yPos)
        .attr("stroke", stroke).attr("stroke-width", 2)
        .attr("stroke-dasharray", dash);

      g.append("text")
        .attr("x", 6).attr("y", yPos - 6)
        .style("font-size", "12px")
        .style("fill", stroke)
        .text(label);
    }

    hline(pageData.minPassing, "orange", "2,6", "minimum passing grade = " + pageData.minPassing + "%");
    hline(pageData.officialPercent, "rgba(0,0,255,0.70)", "6,4", "official current grade");

    // what-if line (dynamic)
    let whatifVal = updateStats();
    const whatIfLine = g.append("line")
      .attr("x1", 0).attr("x2", innerW)
      .attr("y1", y(whatifVal)).attr("y2", y(whatifVal))
      .attr("stroke", "rgba(0,128,0,0.75)")
      .attr("stroke-width", 2)
      .attr("stroke-dasharray", "2,4");

    const whatIfLabel = g.append("text")
      .attr("x", 6).attr("y", y(whatifVal) - 6)
      .style("font-size", "12px")
      .style("fill", "rgba(0,128,0,0.85)")
      .text("what-if overall grade");

    const line = d3.line()
      .x((d, i) => x(pageData.assessmentLabels[i]))
      .y((d) => y(d))
      .defined((d) => Number.isFinite(d));

    const assessPath = g.append("path")
      .datum(pageData.currentScores)
      .attr("fill", "none")
      .attr("stroke", "rgba(255,0,0,0.35)")
      .attr("stroke-width", 2)
      .attr("d", line);

    // ghost rings at original scores (non-interactive)
    g.selectAll("circle.ghost")
      .data(pageData.originalScores.map((v, i) => ({v:v, i:i})).filter(d => Number.isFinite(d.v)))
      .enter().append("circle")
      .attr("class", "ghost")
      .attr("cx", d => x(pageData.assessmentLabels[d.i]))
      .attr("cy", d => y(d.v))
      .attr("r", 9)
      .attr("fill", "none")
      .attr("stroke", "rgba(0,0,0,0.35)")
      .attr("stroke-width", 2)
      .style("pointer-events", "none");

    // visible dots (red; missing are hollow)
    const dots = g.selectAll("circle.dot")
      .data(pageData.currentScores.map((v, i) => ({v:v, i:i})))
      .enter().append("circle")
      .attr("class", "dot")
      .attr("cx", d => x(pageData.assessmentLabels[d.i]))
      .attr("cy", d => y(d.v))
      .attr("r", 7)
      .attr("fill", d => pageData.missingFlags[d.i] ? "white" : "red")
      .attr("stroke", "red")
      .attr("stroke-width", 2)
      .style("pointer-events", "none");

    // hit targets (big, transparent, draggable)
    const hits = g.selectAll("circle.hit")
      .data(pageData.currentScores.map((v, i) => ({v:v, i:i})))
      .enter().append("circle")
      .attr("class", "hit")
      .attr("cx", d => x(pageData.assessmentLabels[d.i]))
      .attr("cy", d => y(d.v))
      .attr("r", 26)
      .attr("fill", "transparent")
      .style("cursor", "ns-resize");

    function refresh(){
      dots.data(pageData.currentScores.map((v, i) => ({v:v, i:i})))
        .attr("cy", d => y(d.v));

      hits.data(pageData.currentScores.map((v, i) => ({v:v, i:i})))
        .attr("cy", d => y(d.v));

      assessPath.datum(pageData.currentScores).attr("d", line);

      whatifVal = updateStats();
      const yW = y(whatifVal);
      whatIfLine.attr("y1", yW).attr("y2", yW);
      whatIfLabel.attr("y", yW - 6);
    }

    const drag = d3.drag()
      .on("start", (event, d) => {
        try { if (event.sourceEvent) event.sourceEvent.preventDefault(); } catch (e) {}
      })
      .on("drag", (event, d) => {
        const newY = clamp(event.y, 0, innerH);
        const newVal = clamp(y.invert(newY), 0, pageData.yMax);
        pageData.currentScores[d.i] = Math.round(newVal * 10) / 10;

        const orig = pageData.originalScores[d.i];
        const delta = Number.isFinite(orig) ? (pageData.currentScores[d.i] - orig) : NaN;
        let deltaTxt = "";
        if (Number.isFinite(delta)) {
          deltaTxt = " (" + (delta >= 0 ? "+" : "") + delta.toFixed(1) + "%)";
        }
        const label = pageData.assessmentLabels[d.i];
        const html = "<b>" + label + "</b><br/>" + pageData.currentScores[d.i].toFixed(1) + "%" + deltaTxt;

        const xy = clientXY(event.sourceEvent);
        const wrapRect = wrap.getBoundingClientRect();
        showTip(html, xy.x - wrapRect.left, xy.y - wrapRect.top);

        refresh();
      })
      .on("end", () => { hideTip(); });

    hits.call(drag);

    document.getElementById("resetBtn").onclick = () => {
      pageData.currentScores = pageData.originalScores.map((v, i) => (Number.isFinite(v) ? v : 0.0));
      refresh();
    };

    return {svg: svg};
  }

  if (typeof d3 === "undefined") {
    wrap.innerHTML = "D3 failed to load. If your network blocks CDNs, run with --d3 local and place d3.v7.min.js in the output folder.";
  } else {
    render();
    // debounced rerender on resize
    let t = null;
    window.addEventListener("resize", () => {
      clearTimeout(t);
      t = setTimeout(() => { hideTip(); render(); }, 120);
    });
  }
  </script>
</body>
</html>

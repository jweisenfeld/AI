<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=yes, maximum-scale=5"/>
  <title>Physics Grade History — Cabrera Esparza, Alexis (45819)</title>
  <style>
    :root { --card-border:#ddd; --muted:#666; --blue:#2563eb; --red:#dc2626; --brown:#92400e; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:14px; background:#fff; }
    .wrap { max-width:1200px; margin:0 auto; }
    h2 { margin:0 0 8px 0; font-size:22px; font-weight:bold; }
    .cards { display:grid; grid-template-columns:repeat(3, minmax(0, 1fr)); gap:10px; margin:12px 0; }
    .card { border:1px solid var(--card-border); border-radius:10px; padding:10px; background:#fff; }
    .label { font-size:12px; color:#555; margin-bottom:2px; }
    .value { font-size:22px; font-weight:750; }
    .row { display:flex; gap:10px; align-items:center; margin:10px 0; }
    button { padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#f7f7f7; cursor:pointer; font-size:14px; }
    button:hover { background:#f0f0f0; }
    #chartWrap { width:100%; height:65vh; min-height:500px; border:1px solid #ddd; border-radius:10px; overflow:hidden; background:#fff; position:relative; }
    .footnote { margin-top:12px; padding:10px; background:#f9f9f9; border-left:3px solid var(--blue); font-size:13px; color:var(--muted); line-height:1.5; }
    #dragLabel { position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.85); color:#fff; padding:8px 12px; border-radius:8px; font-size:14px; display:none; pointer-events:none; z-index:10; }
    @media (max-width: 900px) { .cards { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <h2 id="studentTitle">Physics Grade History: 45819</h2>
    <div style="margin:4px 0 8px 0;"><a href="https://psd1.net/alexis269" style="color:#2563eb;font-size:15px;text-decoration:none;" target="_blank">&#x1F3E0; Your Home Page</a></div>

    <div class="cards">
      <div class="card">
        <div class="label">Official current grade (gradebook export)</div>
        <div class="value" id="officialVal">—</div>
      </div>
      <div class="card">
        <div class="label">What-if overall grade (updates as you drag)</div>
        <div class="value" id="whatifVal">—</div>
      </div>
      <div class="card">
        <div class="label">Change vs official</div>
        <div class="value" id="deltaVal">—</div>
      </div>
    </div>

    <div class="row">
      <button id="resetBtn" type="button">Reset scores</button>
    </div>

    <div id="chartWrap">
      <div id="dragLabel"></div>
    </div>

    <div class="footnote">
      <strong>Grade calculation model:</strong> overall = (0.90 × average(assessments)) + (0.10 × lesson_average) + constant_offset.
      The lesson average and constant offset are held fixed so the page starts at your official current grade.
      Your current grade is the average of your assessment grades (the red dots).
    </div>
    <div class="footnote" style="border-left-color:#2563eb;"><a href="https://psd1.net/alexis269" style="color:#2563eb;text-decoration:none;" target="_blank">&#x1F3E0; Your Home Page</a></div>
    <div class="footnote" style="border-left-color:#666;">Updated 2026-02-20 02:36:49</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
  const pageData = {"studentId": "45819", "studentName": "Cabrera Esparza, Alexis", "milestones": [{"date": "2026-02-06T00:00:00", "label": "Unit 6 Assessment"}, {"date": "2026-02-25T00:00:00", "label": "Unit 8 Assessment"}, {"date": "2026-03-18T00:00:00", "label": "Unit 9 Assessment"}, {"date": "2026-04-03T00:00:00", "label": "Unit 14 Assessment"}, {"date": "2026-05-01T00:00:00", "label": "Unit 19 Assessment"}, {"date": "2026-05-13T00:00:00", "label": "Unit 22 Assessment"}, {"date": "2026-06-02T00:00:00", "label": "Unit 29 Assessment"}], "otherMilestones": [{"date": "2026-06-11T00:00:00", "label": "END OF SEMESTER 2 - 2026-06-11"}], "history": [{"date": "2026-01-18T00:00:00", "percent": 100.0}, {"date": "2026-01-19T00:00:00", "percent": 100.0}, {"date": "2026-01-25T00:00:00", "percent": 100.0}, {"date": "2026-01-26T00:00:00", "percent": 100.0}, {"date": "2026-01-27T00:00:00", "percent": 100.0}, {"date": "2026-01-28T00:00:00", "percent": 100.0}, {"date": "2026-01-29T00:00:00", "percent": 100.0}, {"date": "2026-01-30T00:00:00", "percent": 100.0}, {"date": "2026-01-31T00:00:00", "percent": 100.0}, {"date": "2026-02-01T00:00:00", "percent": 100.0}, {"date": "2026-02-02T00:00:00", "percent": 95.0}, {"date": "2026-02-04T00:00:00", "percent": 95.0}, {"date": "2026-02-05T00:00:00", "percent": 95.0}, {"date": "2026-02-06T00:00:00", "percent": 94.0}, {"date": "2026-02-07T00:00:00", "percent": 94.0}, {"date": "2026-02-08T00:00:00", "percent": 94.0}, {"date": "2026-02-09T00:00:00", "percent": 94.0}, {"date": "2026-02-10T00:00:00", "percent": 94.0}, {"date": "2026-02-11T00:00:00", "percent": 94.0}, {"date": "2026-02-12T00:00:00", "percent": 94.0}, {"date": "2026-02-13T00:00:00", "percent": 94.0}, {"date": "2026-02-15T00:00:00", "percent": 94.0}, {"date": "2026-02-17T00:00:00", "percent": 94.0}, {"date": "2026-02-18T00:00:00", "percent": 72.0}, {"date": "2026-02-19T00:00:00", "percent": 72.0}, {"date": "2026-02-20T00:00:00", "percent": 72.0}], "originalScores": [89.0, 93.0, null, null, null, null, null], "currentScores": [89.0, 93.0, 0.0, 0.0, 0.0, 0.0, 0.0], "missingFlags": [false, false, true, true, true, true, true], "officialPercent": 72.0, "lessonAvg": 0.0, "weights": {"assessments": 0.9, "lessons": 0.1}, "offset": -9.900000000000006, "gradeLines": [{"value": 60, "label": "2.0"}, {"value": 70, "label": "2.3"}, {"value": 75, "label": "2.7"}, {"value": 80, "label": "3"}, {"value": 85, "label": "3.3"}, {"value": 90, "label": "3.7"}, {"value": 95, "label": "4.0"}]};

  const wrap = document.getElementById("chartWrap");
  const dragLabel = document.getElementById("dragLabel");

  function fmtPct(v){ return (Number.isFinite(v) ? v.toFixed(1) + "%" : "—"); }
  function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
  function avg(vals){
    const xs = vals.filter(v => Number.isFinite(v));
    return xs.length ? xs.reduce((a,b)=>a+b,0)/xs.length : NaN;
  }
  function computeWhatIf(scoresArr){
    // Only include scores that are not missing (filter out by checking missingFlags)
    const validScores = scoresArr.filter((v, i) => !pageData.missingFlags[i] && Number.isFinite(v));
    const assessAvg = validScores.length > 0 ? avg(validScores) : NaN;
    if (!Number.isFinite(assessAvg)) return NaN;
    return pageData.weights.assessments * assessAvg
         + pageData.weights.lessons * pageData.lessonAvg
         + pageData.offset;
  }
  function updateStats(){
    const official = pageData.officialPercent;
    const whatif = computeWhatIf(pageData.currentScores);
    document.getElementById("officialVal").textContent = fmtPct(official);
    document.getElementById("whatifVal").textContent  = fmtPct(whatif);
    document.getElementById("deltaVal").textContent   = Number.isFinite(whatif)
      ? ((whatif - official >= 0 ? "+" : "") + (whatif - official).toFixed(1) + "%")
      : "—";
    return whatif;
  }

  const margin = {top:100, right:50, bottom:100, left:60};

  function render(){
    Array.from(wrap.querySelectorAll("svg")).forEach(n => n.remove());

    const rect = wrap.getBoundingClientRect();
    const W = Math.max(400, rect.width);
    const H = Math.max(500, rect.height);

    const innerW = W - margin.left - margin.right;
    const innerH = H - margin.top - margin.bottom;

    const svg = d3.select(wrap).insert("svg", "#dragLabel")
      .attr("width", W)
      .attr("height", H);

    const g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

    // X scale: time-based for historical data
    const allDates = [
      ...pageData.history.map(d => new Date(d.date)),
      ...pageData.milestones.map(m => new Date(m.date)),
      ...pageData.otherMilestones.map(m => new Date(m.date))
    ];
    const xExtent = d3.extent(allDates);
    const x = d3.scaleTime()
      .domain(xExtent)
      .range([0, innerW]);

    // Y scale: grades 0-105
    const y = d3.scaleLinear()
      .domain([0, 105])
      .range([innerH, 0]);

    // Axes
    g.append("g")
      .attr("transform", "translate(0," + innerH + ")")
      .call(d3.axisBottom(x).ticks(8))
      .selectAll("text")
      .attr("transform", "rotate(45)")
      .style("text-anchor", "start")
      .style("font-size", "11px");

    // Left Y-axis with specific tick values
    const yTickValues = [0, 10, 20, 30, 40, 50, 60, 70, 75, 80, 85, 90, 95, 100];
    g.append("g").call(d3.axisLeft(y).tickValues(yTickValues));

    // Right Y-axis with same tick values
    g.append("g")
      .attr("transform", "translate(" + innerW + ",0)")
      .call(d3.axisRight(y).tickValues(yTickValues));

    // Y-axis label
    g.append("text")
      .attr("x", -40).attr("y", -8)
      .style("font-size", "13px")
      .style("fill", "#333")
      .text("Grade (%)");

    // Frame lines at 0% and 100% (black solid)
    g.append("line")
      .attr("x1", 0).attr("x2", innerW)
      .attr("y1", y(0)).attr("y2", y(0))
      .attr("stroke", "black")
      .attr("stroke-width", 2);

    g.append("line")
      .attr("x1", 0).attr("x2", innerW)
      .attr("y1", y(100)).attr("y2", y(100))
      .attr("stroke", "black")
      .attr("stroke-width", 2);

    // Standards-based grade lines (brown dotted)
    pageData.gradeLines.forEach(gl => {
      const yPos = y(gl.value);
      g.append("line")
        .attr("x1", 0).attr("x2", innerW)
        .attr("y1", yPos).attr("y2", yPos)
        .attr("stroke", "#92400e")
        .attr("stroke-width", 1.5)
        .attr("stroke-dasharray", "3,3");

      // Label at left, center, right
      [0.02, 0.5, 0.98].forEach(xPos => {
        const ha = xPos < 0.1 ? "start" : (xPos === 0.5 ? "middle" : "end");
        g.append("text")
          .attr("x", xPos * innerW)
          .attr("y", yPos - 2)
          .style("font-size", "10px")
          .style("fill", "#92400e")
          .style("text-anchor", ha)
          .text(gl.label);
      });
    });

    // Assessment milestone lines (blue dashed)
    pageData.milestones.forEach(m => {
      const xPos = x(new Date(m.date));
      // Shorten label: "Unit 6 Assessment" -> "Unit 6"
      const shortLabel = m.label.replace(" Assessment", "");

      g.append("line")
        .attr("x1", xPos).attr("x2", xPos)
        .attr("y1", 0).attr("y2", innerH)
        .attr("stroke", "#1d4ed8")
        .attr("stroke-width", 1)
        .attr("stroke-dasharray", "4,4");

      // Label just above x-axis (rotated to read downward, hugging the line)
      g.append("text")
        .attr("x", xPos)
        .attr("y", innerH - 3)
        .attr("transform", "rotate(-90," + xPos + "," + (innerH - 3) + ")")
        .style("font-size", "13px")
        .style("fill", "#1d4ed8")
        .style("text-anchor", "start")
        .text(shortLabel);

      // Label at top (starts above 100% line, reading downward)
      g.append("text")
        .attr("x", xPos)
        .attr("y", y(105))
        .attr("transform", "rotate(-90," + xPos + "," + y(105) + ")")
        .style("font-size", "13px")
        .style("fill", "#1d4ed8")
        .style("text-anchor", "start")
        .text(shortLabel);
    });

    // Other milestone lines (blue dashed, no assessment dots)
    pageData.otherMilestones.forEach(m => {
      const xPos = x(new Date(m.date));
      g.append("line")
        .attr("x1", xPos).attr("x2", xPos)
        .attr("y1", 0).attr("y2", innerH)
        .attr("stroke", "#1d4ed8")
        .attr("stroke-width", 1)
        .attr("stroke-dasharray", "4,4");

      // Label just above x-axis (rotated to read downward, hugging the line)
      g.append("text")
        .attr("x", xPos)
        .attr("y", innerH - 3)
        .attr("transform", "rotate(-90," + xPos + "," + (innerH - 3) + ")")
        .style("font-size", "13px")
        .style("fill", "#1d4ed8")
        .style("text-anchor", "start")
        .text(m.label);

      // Label at top (starts above 100% line, reading downward)
      g.append("text")
        .attr("x", xPos)
        .attr("y", y(105))
        .attr("transform", "rotate(-90," + xPos + "," + y(105) + ")")
        .style("font-size", "13px")
        .style("fill", "#1d4ed8")
        .style("text-anchor", "start")
        .text(m.label);
    });

    // Historical grade line (blue solid)
    if (pageData.history.length > 0) {
      const line = d3.line()
        .x(d => x(new Date(d.date)))
        .y(d => y(d.percent));

      g.append("path")
        .datum(pageData.history)
        .attr("fill", "none")
        .attr("stroke", "#2563eb")
        .attr("stroke-width", 2)
        .attr("d", line);

      // Historical points (small blue circles)
      g.selectAll("circle.histPt")
        .data(pageData.history)
        .enter().append("circle")
        .attr("class", "histPt")
        .attr("cx", d => x(new Date(d.date)))
        .attr("cy", d => y(d.percent))
        .attr("r", 4)
        .attr("fill", "#2563eb");

      // Label the last historical point
      const lastHist = pageData.history[pageData.history.length - 1];
      g.append("text")
        .attr("x", x(new Date(lastHist.date)))
        .attr("y", y(lastHist.percent) - 8)
        .style("font-size", "11px")
        .style("fill", "#1e40af")
        .style("text-anchor", "middle")
        .text(lastHist.percent.toFixed(1) + "%");
    }

    // Current grade point (dynamic, moves with what-if)
    let whatifVal = updateStats();
    const lastHistDate = pageData.history.length > 0
      ? new Date(pageData.history[pageData.history.length - 1].date)
      : new Date();

    const currentGradeLine = g.append("line")
      .attr("x1", x(lastHistDate))
      .attr("x2", x(lastHistDate))
      .attr("y1", y(pageData.officialPercent))
      .attr("y2", y(whatifVal))
      .attr("stroke", "#2563eb")
      .attr("stroke-width", 2)
      .attr("stroke-dasharray", "3,3")
      .style("display", Math.abs(whatifVal - pageData.officialPercent) > 0.1 ? "block" : "none");

    const currentGradeDot = g.append("circle")
      .attr("class", "currentGrade")
      .attr("cx", x(lastHistDate))
      .attr("cy", y(whatifVal))
      .attr("r", 6)
      .attr("fill", "#2563eb")
      .attr("stroke", "#1e40af")
      .attr("stroke-width", 2);

    // What-if labels at 4 positions (NE, SE, NW, SW) with yellow background and blinking
    const labelOffsets = [
      { dx: 12, dy: -12, anchor: "start" },   // NE
      { dx: 12, dy: 18, anchor: "start" },    // SE
      { dx: -12, dy: -12, anchor: "end" },    // NW
      { dx: -12, dy: 18, anchor: "end" }      // SW
    ];

    const whatifLabelGroup = g.append("g").attr("class", "whatif-labels");

    // Create background rects and text for each position
    const whatifLabels = labelOffsets.map((off, i) => {
      const grp = whatifLabelGroup.append("g");
      const rect = grp.append("rect")
        .attr("fill", "#ffeb3b")
        .attr("stroke", "#f59e0b")
        .attr("stroke-width", 1)
        .attr("rx", 3)
        .attr("ry", 3);
      const txt = grp.append("text")
        .style("font-size", "13px")
        .style("fill", "#1e40af")
        .style("font-weight", "bold")
        .style("text-anchor", off.anchor);
      return { grp, rect, txt, off };
    });

    function updateWhatifLabels(cx, cy, val) {
      whatifLabels.forEach(({ grp, rect, txt, off }) => {
        const tx = cx + off.dx;
        const ty = cy + off.dy;
        txt.attr("x", tx).attr("y", ty).text(val.toFixed(1) + "%");
        // Measure text and position background rect
        const bbox = txt.node().getBBox();
        rect.attr("x", bbox.x - 3)
            .attr("y", bbox.y - 1)
            .attr("width", bbox.width + 6)
            .attr("height", bbox.height + 2);
      });
    }

    updateWhatifLabels(x(lastHistDate), y(whatifVal), whatifVal);

    // Blinking animation for the what-if labels
    function blinkWhatifLabels() {
      whatifLabelGroup
        .transition().duration(500).style("opacity", 0.3)
        .transition().duration(500).style("opacity", 1)
        .on("end", blinkWhatifLabels);
    }
    blinkWhatifLabels();

    // Assessment dots (draggable red dots on milestone dates)
    // Ghost rings at original positions (non-interactive)
    g.selectAll("circle.ghost")
      .data(pageData.milestones.map((m, i) => ({m:m, i:i, v:pageData.originalScores[i]})).filter(d => Number.isFinite(d.v)))
      .enter().append("circle")
      .attr("class", "ghost")
      .attr("cx", d => x(new Date(d.m.date)))
      .attr("cy", d => y(d.v))
      .attr("r", 9)
      .attr("fill", "none")
      .attr("stroke", "rgba(0,0,0,0.3)")
      .attr("stroke-width", 2)
      .style("pointer-events", "none");

    // Visible assessment dots (only show if not missing)
    const assessDots = g.selectAll("circle.assessDot")
      .data(pageData.milestones.map((m, i) => ({m:m, i:i, v:pageData.currentScores[i], missing: pageData.missingFlags[i]})))
      .enter().append("circle")
      .attr("class", "assessDot")
      .attr("cx", d => x(new Date(d.m.date)))
      .attr("cy", d => y(d.v))
      .attr("r", 8)
      .attr("fill", d => d.missing ? "none" : "#dc2626")
      .attr("stroke", "#dc2626")
      .attr("stroke-width", 2)
      .style("pointer-events", "none")
      .style("display", d => d.missing ? "none" : "block");

    // Hit targets for dragging (large transparent circles)
    const hits = g.selectAll("circle.hit")
      .data(pageData.milestones.map((m, i) => ({m:m, i:i, v:pageData.currentScores[i], missing: pageData.missingFlags[i]})))
      .enter().append("circle")
      .attr("class", "hit")
      .attr("cx", d => x(new Date(d.m.date)))
      .attr("cy", d => y(d.v))
      .attr("r", 28)
      .attr("fill", "transparent")
      .style("cursor", "ns-resize")
      .style("display", d => d.missing ? "none" : "block");

    function refresh(){
      assessDots.data(pageData.milestones.map((m, i) => ({m:m, i:i, v:pageData.currentScores[i], missing: pageData.missingFlags[i]})))
        .attr("cy", d => y(d.v));

      hits.data(pageData.milestones.map((m, i) => ({m:m, i:i, v:pageData.currentScores[i], missing: pageData.missingFlags[i]})))
        .attr("cy", d => y(d.v));

      whatifVal = updateStats();
      const yW = y(whatifVal);
      currentGradeDot.attr("cy", yW);
      updateWhatifLabels(x(lastHistDate), yW, whatifVal);

      currentGradeLine
        .attr("y2", yW)
        .style("display", Math.abs(whatifVal - pageData.officialPercent) > 0.1 ? "block" : "none");
    }

    const drag = d3.drag()
      .on("start", (event, d) => {
        try { if (event.sourceEvent) event.sourceEvent.preventDefault(); } catch (e) {}
      })
      .on("drag", (event, d) => {
        const newY = clamp(event.y, 0, innerH);
        const newVal = clamp(y.invert(newY), 0, 100);  // Max 100%
        pageData.currentScores[d.i] = Math.round(newVal * 10) / 10;

        const orig = pageData.originalScores[d.i];
        const delta = Number.isFinite(orig) ? (pageData.currentScores[d.i] - orig) : 0;
        const deltaTxt = (delta >= 0 ? "+" : "") + delta.toFixed(1) + "%";

        dragLabel.innerHTML = "<strong>" + d.m.label + "</strong><br/>" + pageData.currentScores[d.i].toFixed(1) + "% (" + deltaTxt + ")";
        dragLabel.style.display = "block";

        refresh();
      })
      .on("end", () => {
        dragLabel.style.display = "none";
      });

    hits.call(drag);

    document.getElementById("resetBtn").onclick = () => {
      pageData.currentScores = pageData.originalScores.map(v => (Number.isFinite(v) ? v : 0.0));
      pageData.missingFlags = pageData.originalScores.map(v => !Number.isFinite(v));
      dragLabel.style.display = "none";
      refresh();
    };

    return {svg: svg};
  }

  if (typeof d3 === "undefined") {
    wrap.innerHTML = "D3 failed to load. Check your internet connection.";
  } else {
    render();
    let t = null;
    window.addEventListener("resize", () => {
      clearTimeout(t);
      t = setTimeout(() => { dragLabel.style.display = "none"; render(); }, 150);
    });
  }
  </script>
</body>
</html>
